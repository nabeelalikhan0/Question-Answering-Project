{% extends "base.html" %}
{% block title %}Chatbot{% endblock title %}
{% load static %}
{% load widget_tweaks %}

{% block content %}
<div class="min-h-screen flex bg-gradient-to-br from-indigo-600 via-purple-500 to-pink-500">

  <!-- Sidebar -->
  <aside class="w-64 bg-white/20 backdrop-blur-lg p-4 border-r border-white/30 overflow-y-auto">
    <h2 class="text-white font-semibold mb-4">Previous Chats</h2>

    <!-- Search Bar -->
    <form method="get" action="" class="mb-4">
      <input type="text" name="search" value="{{ search_query }}"
        placeholder="Search chats..."
        class="w-full px-3 py-2 rounded-lg text-black focus:outline-none focus:ring-2 focus:ring-pink-400" />
      <button type="submit"
        class="mt-2 w-full px-3 py-2 rounded-lg bg-pink-500 text-white hover:bg-pink-600 transition">
        Search
      </button>
    </form>

    {% if previous_sessions %}
      <ul class="space-y-2">
        {% for session in previous_sessions %}
          <li>
            <a href="?session_id={{ session.session_id }}"
               class="block px-3 py-2 rounded-lg bg-white/10 hover:bg-white/20 text-white text-sm transition">
              Chat on {{ session.last_message_time|date:"M d, Y H:i" }}
            </a>
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <p class="text-white/70 text-sm">No previous chats</p>
    {% endif %}
  </aside>

  <!-- Main Chat Area -->
  <div class="flex-1 flex flex-col h-screen overflow-hidden">

    <!-- Header -->
    <header class="text-white font-semibold text-2xl text-center py-4 bg-gradient-to-r from-pink-500/90 via-purple-500/90 to-indigo-500/90 shadow-lg tracking-wide">
      RAG Question Answering System
    </header>

    <!-- Upload Form -->
    <section class="p-4 border-b border-white/20">
      <form action="" enctype="multipart/form-data" method="post" class="flex flex-col sm:flex-row gap-3">
        {% csrf_token %}
        {{ form.file|add_class:"flex-grow text-sm text-white border border-white/40 rounded-lg bg-white/10 placeholder-gray-300 focus:outline-none focus:ring-2 focus:ring-pink-400" }}
        <button type="submit" class="px-5 py-2 rounded-lg bg-gradient-to-r from-pink-500 to-purple-500 text-white font-medium shadow hover:scale-105 hover:opacity-90 transition">
          Upload
        </button>
      </form>

      {% if file_text %}
        <div class="mt-4 max-h-28 overflow-auto text-sm p-3 rounded-lg bg-white/10 text-white border border-white/20 whitespace-pre-wrap">
          {{ file_text }}
        </div>
      {% endif %}
    </section>

    <!-- Chat History -->
    <main id="chat-history" class="flex-1 overflow-y-auto p-6 space-y-4">
      {% if chat_history %}
        {% for chat in chat_history %}
          <!-- User Message -->
          <div class="flex justify-start">
            <div class="bg-white/80 dark:bg-gray-800/80 text-gray-900 dark:text-gray-200 px-4 py-2 rounded-2xl shadow max-w-[75%]">
              {{ chat.user_message }}
            </div>
          </div>

          <!-- AI Response -->
          {% if chat.ai_response %}
          <div class="flex justify-end">
            <div class="bg-gradient-to-r from-blue-500 to-indigo-500 text-white px-4 py-2 rounded-2xl shadow max-w-[75%]">
              {{ chat.ai_response }}
            </div>
          </div>
          {% endif %}
        {% endfor %}
      {% else %}
        <p class="text-white/80 text-center">Upload a file and start chatting!</p>
      {% endif %}
    </main>

    <!-- Chat Input -->
    {% if file_text %}
    <section class="border-t border-white/20 p-4 bg-white/10">
      <form action="" method="post" class="flex items-center gap-3">
        {% csrf_token %}
        <input type="text" name="message" id="message" placeholder="Type your question..." required
          class="flex-grow rounded-full px-5 py-2 border border-white/30 bg-white/10 text-white placeholder-white/70 focus:outline-none focus:ring-2 focus:ring-pink-400" />

        <!-- Send -->
        <button type="submit" class="rounded-full px-5 py-2 bg-gradient-to-r from-pink-500 to-purple-500 text-white shadow hover:scale-105 transition">
          Send
        </button>
      </form>
    </section>
    {% endif %}
  </div>
</div>

<script>
window.onload = () => {
  const chatHistory = document.getElementById('chat-history');
  if (chatHistory) chatHistory.scrollTop = chatHistory.scrollHeight;
};
</script>
{% endblock content %}
